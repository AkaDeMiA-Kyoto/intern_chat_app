{% extends 'myapp/base.html' %}
{% load static %}

{% block extra_style %}
<link rel="stylesheet" type="text/css" href="{% static 'myapp/css/friends.css' %}" />
{% endblock %}

{% block header-title %}友達{% endblock %}

{% block content %}
<div class="search_box">
    <form action="" method="GET">
        {% csrf_token %}
        {{ form }}
        <button type="submit" class="btn btn-secondary" id="search">検索</button>
    </form>
</div>
{% for friend in user %}
{% if friend != me %}
<a href="{% url 'talk_room' %}/{{me.id}}/{{friend.id}}">
    <div class="friend-block">
        <div class="friend-name">{{friend.username}}</div>
        {% for latest_msg in msg %}
        {% if latest_msg.sender.id == friend.id %}
            <div class="message_content">
                <p>
                {{latest_msg.content}}</p>
            </div>
            <div class="message_time">
                {{latest_msg.pub_date|date:"n/j H:i"}}
            </div>
        {% endif %}
        {% if latest_msg.receiver.id == friend.id %}
            <div class="message_content">
                <p>
                {{latest_msg.content}}</p>
            </div>
            <div class="message_time">
                {{latest_msg.pub_date|date:"n/j H:i"}}
            </div>
        {% endif %}
        {% endfor %}
    </div>
</a>
{% endif %}
{% endfor %}
<script>
    const searchBtn = document.getElementById("search");
    const searcInput = document.getElementById("id_find");
    searchBtn.addEventListener("click",function(e){
        e.preventDefault();
        const xhr = new XMLHttpRequest();
        xhr.open("GET","{% url 'search_user' %}?q=" + searcInput.value);
        xhr.send();
        xhr.addEventListener("load",function(){
            console.log(xhr.status);
            console.log(typeof xhr.response)
            var json = JSON.parse(xhr.response);
            console.log(json.user_data);
        });
    })
</script>
{% endblock %}