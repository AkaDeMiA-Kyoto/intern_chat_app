{% extends 'myapp/base.html' %}
{% load static %}

{% block extra_style %}
<link rel="stylesheet" type="text/css" href="{% static 'myapp/css/talk_room.css' %}">
{% endblock %}

{% block header-title %}{{ friend.username }}{% endblock %}
{% block header-item %}
<a href="{% url 'friends' %}"><img src="/media/img/upload/back.png" alt="back" width="40vw"></a>
{% endblock %}

{% block content %}
<!-- トーク履歴 -->
<div class="logs" id="chat-log">
    {% for show_message in message_log %}
    <div class="log">
        {% if show_message.send_from == me %}
            {% if me.img %}
            <img src="/media/{{ me.img }}" alt="icon" width="30vw" height="30vh">
            {% else %}
            <img src="/media/img/upload/person.png" alt="icon" width="30vw" height="30vw">
            {% endif %}
            <p class="send_from">{{ me.username }}:</p>
        {% else %}
            {% if friend.img %}
            <img src="/media/{{ friend.img }}" alt="icon" width="30vw" height="30vh">
            {% else %}
            <img src="/media/img/upload/person.png" alt="icon" width="30vw" height="30vw">
            {% endif %}
            <p class="send_from">{{ friend.username}}:</p>
        {% endif %}
        <p class="message">{{ show_message.message|safe }}</p>
        <p class="date">{{ show_message.posted_date|date:"m/d" }}</p>
        <p class="time">{{ show_message.posted_date|date:"H:i" }}</p>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block footer %}
<!-- 送信 -->
<footer>
    <!-- <form action="{% url 'talk_room' friend.username %}" method="POST"> -->
        {% csrf_token %}
        <div class="post_message">
            {{ form }}
            <input type="submit" value="送信" id="chat-message-submit">
        </div>
        {{ room_name|json_script:"room-name"}}
    <!-- </form> -->
</footer>
{% endblock %}
{% block script %}
<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/talk_room/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const newLog = document.createElement('div');
        newLog.setAttribute("class", "log");

        const newMessage = document.createElement('p');
        const message = document.createTextNode(data.message);
        //pタグ内にnewMessageを追加
        newMessage.appendChild(message);
        newMessage.setAttribute("class", "message");

        const img = document.createElement('img');
        if (data.send_from_icon === "") {
            img.setAttribute("src", "/media/img/upload/person.png");
        } else {
            img.setAttribute("src", "/media/" + data.send_from_icon);
        }
        img.setAttribute("width", "30vw");
        img.setAttribute("height", "30vh");

        const newMessageSendFrom = document.createElement('p');
        const sendFrom = document.createTextNode(data.send_from + ':');
        newMessageSendFrom.appendChild(sendFrom);
        newMessageSendFrom.setAttribute("class", "send_from");

        let now = new Date();
        let month = now.getMonth() + 1;
        let day = now.getDate();
        let hour = now.getHours();
        let minute = now.getMinutes();
        const dateTag = document.createElement('p');
        const date = document.createTextNode(month + '/' + day);
        dateTag.appendChild(date);
        dateTag.setAttribute("class", "date");

        const timeTag = document.createElement('p');
        const time = document.createTextNode(hour + ':' + minute);
        timeTag.appendChild(time);
        timeTag.setAttribute("class", "time");

        //logの最後にpタグ追加
        newLog.appendChild(img);
        newLog.appendChild(newMessageSendFrom);
        newLog.appendChild(newMessage);
        newLog.appendChild(dateTag);
        newLog.appendChild(timeTag);
        //親要素divを取得
        const place = document.getElementById('chat-log');
        //logをlogsの最後に追加
        place.appendChild(newLog);
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e){
        if (e.keyCode === 13) { //enter,return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };
</script>
{% endblock %}
