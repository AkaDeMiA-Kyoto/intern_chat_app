{% extends 'myapp/base.html' %}
{% load static %}

{% block extra_style %}
    <link rel="stylesheet" type="text/css" href="{% static 'myapp/css/talk_room.css' %}" />
{% endblock %}

{% block header-title %}
    {{ partner }}
{% endblock %}

{% block content %}
<ul id="message-area">
    {% for message in messages %}
        <li>
            {% if message.sender == request.user.unique_id %}
                <div class="message from-user">
                    <div class="message-content from-user-content">{{message.contents}}</div>
                    <!-- <div class="message-datetime">{{message.date_joined}}</div> -->
                </div>
            {% elif message.sender == partner_id %}
                <div class="message">
                    <div class="message-content">{{message.contents}}</div>
                    <!-- <div class="message-datetime">{{message.date_joined}}</div> -->
                </div>
            {% endif %}
        </li><br>
    {% endfor %}
</ul>
<form action="{% url 'myapp:talk_room' partner %}" method="post">
    {% csrf_token %}
    {{ form.contents }}
    <input type="text" style="display: none;">
    <input type="button" value="send" id="send-button">
</form>

// ここ、セキュリティ的にまずいのでどうにかするべき
{{ partner|json_script:"partner" }}
{{ partner_id|json_script:"partner-id" }}
{{ request.user.unique_id|json_script:"user-id" }}

<script>
    const partner = JSON.parse(document.getElementById('partner').textContent);
    const partnerId = JSON.parse(document.getElementById('partner-id').textContent);
    const userId = JSON.parse(document.getElementById('user-id').textContent);

    // console.log(partner);
    // console.log(partnerId);
    // console.log(userId);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/talk_room/'
        + partner
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        let cssMessage = 'message', cssMessageContent = 'message-content';
        console.log(data);
        if(userId == data.sender){
            cssMessage += ' from-user';
            cssMessageContent += ' from-user-content';
        }
        //可読性のなさ
        let htmlMessageContent = "<div class=\"" + cssMessageContent + "\">" + data.message + "</div>";
        let htmlMessage = "<div class=\"" + cssMessage + "\">" + htmlMessageContent + "</div>"

        let html = document.createElement('li');
        html.innerHTML = htmlMessage;

        document.getElementById('message-area').appendChild(html);

    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // document.querySelector('#chat-message-input').focus();
    // document.querySelector('#id_contents').onkeyup = function(e) {
    //     if (e.keyCode === 13) {  // enter, return
    //         document.querySelector('#send-button').click();
    //     }
    // };

    document.querySelector('#send-button').onclick = function(e) {
        const messageInputDom = document.querySelector('#id_contents');
        const message = messageInputDom.value;
        // console.log(message);
        chatSocket.send(JSON.stringify({
            'message': message,
            'sender': userId,
            'receiver': partnerId
        }));
        messageInputDom.value = '';
    };
</script>
{% endblock %}