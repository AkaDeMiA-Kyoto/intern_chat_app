{% extends 'myapp/base.html' %}
{% load static %}

{% block extra_style %}
<link rel="stylesheet" type="text/css" href="{% static 'myapp/css/talk_room.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" integrity="sha512-YWzhKL2whUzgiheMoBFwW8CKV4qpHQAEuvilg9FAn5VJUDwKZZxkJNuGM4XkWuk94WCrrwslk8yWNGmY1EduTA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
{% endblock %}

{% block header %}
<header class="header bg-gray-200">
    <div class="header-container">
        <div class="flex content-between">
            <a class="mt-3" href="{% url 'myapp:profile' %}"><i class="fa-solid fa-angle-left fa-2x"></i></a>
            <span class="header-container__title">
                {% block header-title %}<div id="friend_name">{{friend}}</div>{% endblock %}
            </span>
            <div class="absolute right-0 top-3 leading-4 m-auto text-center"><button onclick="window.location.reload(true);" class="btn btn-secondary">更新</button></div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
    <div id="chat-log"></div>
    {% for item in data %}
        <!-- やりとりしているメッセージの受け手がユーザー、かつ、やりとりしている送り手がトーク画面の相手 -->
        {% if item.receiver.id == user.id %}
            {% if item.sender.id == friend.id %}
                <div  class="p-3 border-b border-gray-300 border-solid">
                    <div class="flex">
                        <i class="fa-solid fa-angle-right"></i>
                        <p class="ml-2 text-sm">{{item.receiver}}</p>
                    </div>
                    <div class="flex content-around">
                        <div class=w-9/12>
                            {{item.content}}
                        </div>
                        <p class="absolute right-2 text-sm">{{item.created_at}}</p>
                    </div>
                </div>
            {% endif %}
        {% endif %}
        {% if item.sender_id == user.id %}
            {% if item.receiver.id == friend.id %}
                <div  class="p-3 border-b border-gray-300 border-solid">
                    <div class="flex">
                        <i class="fa-solid fa-angle-right"></i>
                        <p class="ml-2 text-sm">{{item.receiver}}</p>
                    </div>
                    <div class="flex content-around">
                        <div class="w-9/12">
                            {{item.content}}
                        </div>
                        <p class="absolute right-2 text-sm">{{item.created_at}}</p>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endfor %}
{% endblock %}

{% block footer %}
    <footer class="footer">
        <div class="footer-container bg-gray-200">
            <form class="flex w-full justify-around items-center" method="post">
                <div class="w-8/12">
                    <label class="block">
                        <div class="mt-1">
                            {%csrf_token %}
                            {{form.content}}
                        </div>
                    </label>
                </div>
                <div>
                    <button type="submit" value="send" class="btn btn-secondary" id="chat-message-submit">送信</button>
                </div>
            </form>
        </div>
    </footer>
    {{ user_name|json_script:"user_name" }}
{% endblock %}

{% block extra_js %}
<script>
    const user = JSON.parse(document.getElementById('user_name').textContent);
    console.log(user)
    var url_pathname = window.location.pathname
    var friend_number = url_pathname.split('/')[2]
    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/talk_room/'
        + friend_number
        +'/'
    );

    chatSocket.onmessage = function(e) {
        const receiveData = JSON.parse(e.data)
        const date = new Date()
        const created_at = date.getFullYear() + '年' + (date.getMonth()+1) + '月' + date.getDay() + '日' + date.getHours() + ':' + date.getMinutes()
        if(receiveData.sender == user)
        {
            document.getElementById("chat-log").innerHTML +=`<div  class="p-3 border-b border-gray-300 border-solid">
                                                                    <div class="flex">
                                                                        <i class="fa-solid fa-angle-right"></i>
                                                                        <p class="ml-2 text-sm">` + receiveData.receiver +`</p>
                                                                    </div>
                                                                    <div class="flex content-around">
                                                                        <div class="w-9/12">`
                                                                           + receiveData.message + 
                                                                        `</div>
                                                                        <p class="absolute right-2 text-sm">` + created_at + `</p>
                                                                    </div>
                                                                </div>`
        }
        if(receiveData.receiver == user)
        {
            document.getElementById("chat-log").innerHTML +=`<div  class="p-3 border-b border-gray-300 border-solid">
                                                                    <div class="flex">
                                                                        <i class="fa-solid fa-angle-right"></i>
                                                                        <p class="ml-2 text-sm">` + receiveData.receiver +`</p>
                                                                    </div>
                                                                    <div class="flex content-around">
                                                                        <div class="w-9/12">`
                                                                           + receiveData.message + 
                                                                        `</div>
                                                                        <p class="absolute right-2 text-sm">` + created_at + `</p>
                                                                    </div>
                                                                </div>`
        }

        
    }

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly')
    }

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };
</script>
{% endblock %}