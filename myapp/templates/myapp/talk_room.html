{% extends 'myapp/base.html' %}
{% load static %}

{% block extra_style %}
<link rel="stylesheet" type="text/css" href="{% static 'myapp/css/talk_room.css' %}">
{% endblock %}

{% block header-title %}{{ friend.username }}{% endblock %}
{% block header-item %}
<a href="{% url 'friends' %}"><img src="/media/img/upload/back.png" alt="back" width="40vw"></a>
{% endblock %}

{% block content %}
<!-- トーク履歴 -->
<div class="logs">
    {% for show_message in message_log %}
    <div class="log">
        {% if show_message.send_from == me %}
            {% if friend.img %}
            <img src="/media/{{ me.img }}" alt="icon" width="30vw" height="30vh">
            {% else %}
            <img src="/media/img/upload/person.png" alt="icon" width="30vw" height="30vw">
            {% endif %}
            <p class="send_from">{{ me.username }}:</p>
        {% else %}
            {% if friend.img %}
            <img src="/media/{{ friend.img }}" alt="icon" width="30vw" height="30vh">
            {% else %}
            <img src="/media/img/upload/person.png" alt="icon" width="30vw" height="30vw">
            {% endif %}
            <p class="send_from">{{ friend.username}}:</p>
        {% endif %}
        <p class="message">{{ show_message.message|safe }}</p>
        <p class="date">{{ show_message.posted_date|date:"m/d" }}</p>
        <p class="time">{{ show_message.posted_date|date:"H:i" }}</p>
    </div>
    {% endfor %}
    <textarea class="message" id="chat-log" cols="100" rows="20"></textarea><br>
</div>
{% endblock %}

{% block footer %}
<!-- 送信 -->
<footer>
    <!-- <form action="{% url 'talk_room' friend.username %}" method="POST"> -->
        {% csrf_token %}
        <div class="post_message">
            {{ form }}
            <input type="submit" value="送信" id="chat-message-submit">
        </div>
        {{ room_name|json_script:"room-name"}}
    <!-- </form> -->
</footer>
{% endblock %}
{% block script %}
<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/talk_room/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
            document.querySelector('#chat-log').value += (data.message + '\n');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e){
        if (e.keyCode === 13) { //enter,return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };
</script>
{% endblock %}
